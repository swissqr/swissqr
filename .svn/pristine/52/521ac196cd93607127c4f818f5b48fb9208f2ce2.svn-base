package ch.swissqr.paymentslip;

import java.awt.Color;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Properties;

import javax.imageio.ImageIO;

import org.apache.log4j.Logger;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDPageContentStream;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.font.PDFont;
import org.apache.pdfbox.pdmodel.font.PDType1Font;
import org.apache.pdfbox.pdmodel.graphics.image.PDImageXObject;

import ch.swissqr.barcode.QRSwissBarcode;
import ch.swissqr.content.ContentBarcodeCH;
import ch.swissqr.content.ch.Address;
import ch.swissqr.content.ch.IAlternativeSchema;
import ch.swissqr.errors.BarcodeException;
import ch.swissqr.pdf.DocumentBase;
import ch.swissqr.utils.StringUtils;

/**
 * Payment Slip DPF document
 * 
 * @author pschatzmann
 *
 */
public class PaymentSlipPDF extends DocumentBase {
	public enum Format {
		A4, A5, A6, Others
	}

	private static final Logger LOG = Logger.getLogger(PaymentSlipPDF.class);
	private static final float TOP = 95; 
	private static final float LINEHEIGHT = 3.88f; // 3.53f;
	private static final float SECTIONMARGIN = 5.0f;
	public static final float POINT_TO_MM = 0.352778f;
    private static final float POINTS_PER_INCH = 72;
	private static final float USER_UNIT = 2.83441891578f; // mm to point
	private int leftX;
	private int rightX;
	private DateFormat dateFormat;
	private PDPageContentStream contentStream;
	private PDFont fontBold;
	private PDFont font;
	private float currentTop = TOP;
	private boolean printLines = true;
	private PDPage blankPage;
	private boolean autoClose = true;
	private Properties messages;
	private boolean printReceipt;
	private int cutoffLimit = 37;
	
	
	public PaymentSlipPDF() {	
	}
	
	/**
	 * Default constructor
	 * @param content
	 * @param requestedLangauge
	 * @param format
	 * @param printLines
	 * @throws BarcodeException
	 * @throws IOException 
	 */
	public PaymentSlipPDF(ContentBarcodeCH content, String requestedLangauge, Format format, boolean printLines, boolean printReceipt)
			throws BarcodeException, IOException {
		print(content, requestedLangauge, format, printLines, printReceipt);
	}
	
	/**
	 * Constructor for creating an unformatted payment slip with just prints the relevant content
	 * w/o left margin and cut off line printing
	 * @param content
	 * @param requestedLangauge
	 * @throws BarcodeException
	 * @throws IOException 
	 */
	public PaymentSlipPDF(ContentBarcodeCH content, String requestedLangauge) throws BarcodeException, IOException {
		this(content,requestedLangauge, Format.A4,true, true);
	}

	/**
	 * Constructor for existing PDDocument
	 * @param document
	 * @throws BarcodeException
	 */
	public PaymentSlipPDF(PDDocument document) throws BarcodeException {
		dateFormat = DateFormat.getDateInstance(DateFormat.DEFAULT);
		setDocument(document);
	}

	/**
	 * Prints the payment slip
	 * @param content
	 * @param requestedLangauge
	 * @param format
	 * @param printLines
	 * @return 
	 * @throws BarcodeException
	 * @throws IOException 
	 */
	public PDPageContentStream print(ContentBarcodeCH content, String requestedLangauge, Format format, boolean printLines, boolean printReceipt)
			throws BarcodeException, IOException {

		setup(format, content, requestedLangauge, printLines, printReceipt);

		createPDFDocument();
		printPerformationLines(getDocument());
		createPaymentSlip(content);
		createReceipt(content, requestedLangauge, format);

		if (autoClose) {
			contentStream.close();
		}
		return this.contentStream;
	}

	private void setup(Format format, ContentBarcodeCH content, String requestedLangauge,boolean printLines, boolean printReceipt) throws IOException {
		String language = getLangauge(content, requestedLangauge);
		Locale.setDefault(new Locale(language, content.getDebitor().getCountryISO()));
		dateFormat = DateFormat.getDateInstance(DateFormat.DEFAULT);
		this.messages = getProperties(language);
		
		setupPageFormat(format, printLines, printReceipt);
	}
	

	private String getLangauge(ContentBarcodeCH content, String lang) {
		String language = lang;
		if (lang==null) {
			language = content.getProperties().getProperty("language");
		}
		if (language == null) {
			language = "en";
		}
		language =  language.trim().toLowerCase();
		if (!language.matches("de|en|fr|it")) {
			LOG.info("Setting default language to english because of unsupported code: " + lang);
			language = "en";
		}
		return language;
	}

	private void setupPageFormat(Format format, boolean printLines, boolean printReceipts) {
		this.printLines = printLines;
		this.printReceipt = printReceipts;
		//float userUnit = 28.34646f; // 28.34008f
		
		switch (format) {
		case A4:
			blankPage = new PDPage(PDRectangle.A4);
			blankPage.setCropBox(new PDRectangle(210f*USER_UNIT, 297f*USER_UNIT));
			leftX = 65;
			rightX = 120; 
			break;
		case A5:
			blankPage = new PDPage(PDRectangle.A5);
			blankPage.setCropBox(new PDRectangle(210f*USER_UNIT, 148f*USER_UNIT));
			leftX = 65;
			rightX = 120; 
			break;
		case A6:
			// support for others and A6
			this.printLines = false;
			this.printReceipt = false;
			leftX = 5;
			rightX = 60;
			blankPage = new PDPage();
			blankPage.setCropBox(new PDRectangle(150.0f*USER_UNIT, 107.0f*USER_UNIT));
			break;
		default:
			// support for others and A6
			leftX = 65;
			rightX = 120; 
			blankPage = new PDPage();
			blankPage.setCropBox(new PDRectangle(210f*USER_UNIT, 148f*USER_UNIT));
			break;
		}

	}

	/**
	 * Creates a payment slip PDF document
	 * 
	 * @param content
	 * @return
	 * @throws Exception
	 */
	private PDDocument createPaymentSlip(ContentBarcodeCH content) throws BarcodeException {
		try {
			PDDocument document = this.getDocument();
			printBarcode(content, document);

			printPaymentSlipCol1(content, messages, document);
			printPaymentSlipCol2(content, messages);
			printPaymentSlipButtom(content, messages);
			
			return document;
		} catch (Exception ex) {
			throw new BarcodeException(ex);
		}
	}

	public PDDocument createPDFDocument() throws BarcodeException, IOException {
		PDDocument document = new PDDocument();
		setDocument(document);
		document.addPage(blankPage);

		fontBold = PDType1Font.HELVETICA_BOLD;
		font = PDType1Font.HELVETICA;

		contentStream = new PDPageContentStream(document, blankPage);
		return document;
	}


	private void printPerformationLines(PDDocument document) throws IOException {
		if (this.printLines) {
			// print scissors
			contentStream.drawImage(getImageFromResource(document, "/icons/scissors.png", "Scissors"),
					2*USER_UNIT, 106*USER_UNIT, 12*USER_UNIT, 12*USER_UNIT);
			
			// print lines
			float x = 59f;
			contentStream.setLineDashPattern(new float[] { 1*USER_UNIT, 3*USER_UNIT }, 0);
			contentStream.setLineWidth(1f);

			contentStream.setStrokingColor(Color.GRAY);
			contentStream.moveTo(0f*USER_UNIT, 105f*USER_UNIT);
			contentStream.lineTo(210f*USER_UNIT, 105f*USER_UNIT);
			contentStream.stroke();

			contentStream.moveTo(x*USER_UNIT, 0);
			contentStream.lineTo(x*USER_UNIT, 105f*USER_UNIT);
			contentStream.stroke();
		}
	}

	private void printPaymentSlipCol1 (ContentBarcodeCH content, Properties messages, PDDocument document) throws IOException {
		currentTop = TOP;
		printTitle(messages.getProperty("T_TITLE"), leftX, Math.round(currentTop), 11);
		printAmount(content, messages, document, leftX, 32, 1.05f, 1.05f, 8, 14,  8f, 10f);
	}

	private void printPaymentSlipCol2(ContentBarcodeCH content, Properties messages) throws IOException {
		currentTop = TOP;
		contentStream.beginText();

		contentStream.newLineAtOffset(rightX*USER_UNIT, currentTop*USER_UNIT);
		print(messages.getProperty("T_ACCOUNT"), getAccountInfo(content), LINEHEIGHT,8.0f,10.0f);
		//print(null,content.getCreditorInformation().getCreditorAddress().getAddressLines(), LINEHEIGHT, 8.0f,10.0f);
		print(messages.getProperty("T_REF"), content.getPaymentReference().getReferenceFormatted(), LINEHEIGHT);
		print(messages.getProperty("T_INFO"), getAdditionalInfoData(content), LINEHEIGHT,8.0f,10.0f);

		float yBox = printDebitor(content, messages,LINEHEIGHT, 8.0f,10.0f);
		contentStream.endText();
		
		printEmptyAddressBox(this.getDocument(), yBox-2, rightX, 1.05f);
		
	}

	public List<String> getAccountInfo(ContentBarcodeCH content) {
		List<String> accountLines = new ArrayList();
		accountLines.add(StringUtils.formatInGroups(4,content.getCreditorInformation().getIban()));
		accountLines.addAll(Arrays.asList(content.getCreditorInformation().getCreditorAddress().getAddressLines()));
		return accountLines;
	}

	private List<String> getAdditionalInfoData(ContentBarcodeCH content) {
		List<String> info = new ArrayList();
		int maxWordLen = 10;
		info.addAll(StringUtils.splitLines(content.getPaymentReference().getUnstructuredMessage(),getCutoffLimit(),maxWordLen));
		Object billingInfo = content.getPaymentReference().getBillInformation();
		if (billingInfo!=null) {
			info.addAll(StringUtils.splitLines(billingInfo.toString(),getCutoffLimit(),maxWordLen));
		}
		return info;
	}
		

	private float printDebitor(ContentBarcodeCH content, Properties messages, float spacing, float titleFontSize, float textFontSize ) throws IOException {
		float yBox = -10000.0f;
		Address debitor = content.getDebitor();
		if (debitor != null && debitor.isDefined()) {
			print(messages.getProperty("T_DEB"), Arrays.asList(debitor.getAddressLines()), spacing,titleFontSize, textFontSize);
		} else {
			printTitle(messages.getProperty("T_DEB")+" "+messages.getProperty("T_DEB1"));
			yBox = currentTop;
			contentStream.newLineAtOffset(0, -25);
			currentTop = currentTop - 30;
		}
		return yBox;
	}

	private void printAmount(ContentBarcodeCH content, Properties messages, PDDocument document, int leftX, int yPos, float scaleX, float scaleY, int boxXOffset, int boxYPos, float sizeTitle, float sizeText) throws IOException {
		print(messages.getProperty("T_CURRENCY"), content.getPaymentAmount().getCurrency(), leftX, yPos, sizeTitle, sizeText);

		String amount = content.getPaymentAmount().getAmountPrinted();
		if (!StringUtils.isEmpty(amount)) {
			print(messages.getProperty("T_AMOUNT"), amount,
					leftX + 20, yPos, sizeTitle, sizeText);  
		} else {
			// print title and amount box
			printTitle(messages.getProperty("T_AMOUNT"), leftX + 24, yPos, sizeTitle);  //20 -> 28
			contentStream.drawImage(getImageFromResource(document, "/feld/Feld_Betrag_40x15mm.png", "Amount"),
					(leftX + boxXOffset)*USER_UNIT, boxYPos*USER_UNIT, 40*scaleX*USER_UNIT, 15*scaleY*USER_UNIT); // 4 -> 12
		}
	}
	
	/**
	 * Creates the Further information section
	 * @param content
	 * @param messages
	 * @throws IOException
	 */
	private void printPaymentSlipButtom(ContentBarcodeCH content, Properties messages) throws IOException {
		int y = 8;
		
		this.setCutoffLimit(85);
		
		// print ultimate creditor
		if (content.getUltimateCreditor().isDefined()) {
			String title = messages.getProperty("T_ULTIMATECREDITOR");
			String text = content.getUltimateCreditor().getAddressPrinted(", ");
			text = limitLength(text,this.getCutoffLimit());
			printFurtherInformationLine(title, text,leftX, y);
			y -= LINEHEIGHT;
		}
		
		// print alt procedures
		List<IAlternativeSchema> altProcudure = content.getAlternativeSchema();
		for (IAlternativeSchema as : altProcudure) {
			printFurtherInformationLine(as.getTitle(),limitLength(as.getContent(),this.getCutoffLimit()) ,leftX, y);
			y -= LINEHEIGHT;
		}
	}
	
	/**
	 * Prints the receipt section
	 * @param content
	 * @param requestedLangauge
	 * @param format
	 * @param printLines2
	 * @throws IOException 
	 */
	private void createReceipt(ContentBarcodeCH content, String requestedLangauge, Format format) throws IOException {
		if (this.printReceipt) {
			this.setCutoffLimit(29);
			
			int x = 2;
			this.currentTop = TOP;
			float lineHeight = 3.175002f;//2.8f;
	
			this.printTitle(messages.getProperty("T_RECEIPT"),  x, (int)currentTop, 11);
			currentTop-=5;
			
			contentStream.beginText();
			contentStream.newLineAtOffset(x*USER_UNIT, currentTop*USER_UNIT);
			float fontSize = 8f;
			float fontSizeTitle = 6f;
			print(messages.getProperty("T_ACCOUNT"), getAccountInfo(content), lineHeight,fontSizeTitle,fontSize );
			print(messages.getProperty("T_REF"), content.getPaymentReference().getReferenceFormatted(), lineHeight,fontSizeTitle,fontSize);
			
			float yBox = printDebitor(content, messages, lineHeight, fontSizeTitle, fontSize);
			contentStream.endText();		
			
			printEmptyAddressBox(this.getDocument(), yBox+3, x, 0.84f);
			
			printAmount(content, messages, this.getDocument(), x, 33, 0.8f,0.7f, 15, 21, fontSizeTitle, fontSize);
			
			this.printTitle(messages.getProperty("T_ACCEPENCE"),  34, 16, fontSizeTitle);
		}

	}

	
	private String limitLength(String str,int len) {
		String result = str;
		if (str.length()>len) {
			result = result.substring(0,len)+"...";
		}
		return result;
	}

	private Properties getProperties(String lang) throws IOException {
		String resourceName = "language_" + lang;
		messages = StringUtils.loadProperties(resourceName);
		return messages;
	}

	private void printBarcode(ContentBarcodeCH content, PDDocument document) throws Exception, IOException {
		byte barcodeByteArray[] = new QRSwissBarcode(content.isTest()).create(content.getContent(), "png");
		PDImageXObject pdImage = PDImageXObject.createFromByteArray(document, barcodeByteArray, "swiss-qr");
		float scaling = 1.10f;
		contentStream.drawImage(pdImage, (leftX-2)*USER_UNIT, 39*USER_UNIT, 46*scaling*USER_UNIT, 46*scaling*USER_UNIT); // 28
	}

	private void printEmptyAddressBox(PDDocument document, float yBox, int x, float factor) throws IOException {
		if (yBox > 0) {
			yBox = yBox - 25 + 3;
			contentStream.drawImage(getImageFromResource(document, "/feld/Feld_Zahlungspflichtiger_65x25mm.png", "Debitor"), 
			x*USER_UNIT, yBox*USER_UNIT, 65*factor*USER_UNIT, 25*factor*USER_UNIT);
		}
	}

	private PDImageXObject getImageFromResource(PDDocument document, String path, String name) throws IOException {
		BufferedImage img = ImageIO.read(this.getClass().getResourceAsStream(path));
		ByteArrayOutputStream baos = new ByteArrayOutputStream();
		ImageIO.write(img, "png", baos);
		baos.flush();
		byte[] amountByteArray = baos.toByteArray();
		baos.close();
		PDImageXObject amountImage = PDImageXObject.createFromByteArray(document, amountByteArray, name);
		return amountImage;
	}

	private void print(String title, String content, float y) throws IOException {
		print(title, content, y, 8.0f,10.0f);
	}
	
	private void print(String title, String content, float y, float titleFontSize, float textFontSize) throws IOException {
		if (!StringUtils.isEmpty(content)) {
			print(title, Arrays.asList(content), y,titleFontSize, textFontSize);
		}
	}

	private void printTitle(String title) throws IOException {
		printX(title, new ArrayList(), 0);
	}

	
	private void print(String title, List<String> contentArray, float y, float titleFontSize, float textFontSize) throws IOException {
		if (contentArray.size() > 0 && !StringUtils.isEmpty(contentArray.get(0))) {
			printX(title, contentArray, y, titleFontSize, textFontSize);
		}
	}

	private void printX(String title, List<String>  contentArray, float y) throws IOException {
		printX(title, contentArray,y, 8.0f, 10.0f);
	}

	private void printX(String title, List<String>  contentArray, float y, float titleFontSize, float textFontSize) throws IOException {
		if (title!=null) {
			contentStream.setFont(fontBold, titleFontSize * POINT_TO_MM * USER_UNIT);
			contentStream.showText(title);
		}
		contentStream.setFont(font, textFontSize * POINT_TO_MM * USER_UNIT);
		for (String content : contentArray) {
			contentStream.newLineAtOffset(0, -y*USER_UNIT);
			contentStream.showText(cutOff(content));
			currentTop = currentTop - y;
		}
		currentTop = currentTop - SECTIONMARGIN;
		contentStream.newLineAtOffset(0, -SECTIONMARGIN*USER_UNIT);
	}
	
	private String cutOff(String str) {
		String result = str;
		if (str.length()>cutoffLimit) {
			result = str.substring(0,cutoffLimit);
		}
		return result;
	}

	private void printTitle(String title, int x, int y, float fontSize) throws IOException {
		contentStream.beginText();
		// Setting the position for the line
		contentStream.newLineAtOffset(x*USER_UNIT, y*USER_UNIT);
		contentStream.setFont(fontBold, fontSize * POINT_TO_MM * USER_UNIT);
		contentStream.showText(title);
		contentStream.endText();
	}

	private void print(String title, String content, int x, int y, float sizeTitle, float sizeText) throws IOException {
		if (!StringUtils.isEmpty(content)) {
			contentStream.beginText();
			// Setting the position for the line
			contentStream.newLineAtOffset(x*USER_UNIT, y*USER_UNIT);
			contentStream.setFont(fontBold, sizeTitle * POINT_TO_MM * USER_UNIT);
			contentStream.showText(title);
			contentStream.newLineAtOffset(0, -LINEHEIGHT*USER_UNIT);
			contentStream.setFont(font, sizeText * POINT_TO_MM * USER_UNIT);
			contentStream.showText(cutOff(content));
			contentStream.endText();
		}
	}

	/**
	 * Prints the information on one line
	 * @param title
	 * @param content
	 * @param x
	 * @param y
	 * @throws IOException
	 */
	private void printFurtherInformationLine(String title, String content, int x, int y) throws IOException {
		contentStream.beginText();
		contentStream.newLineAtOffset(x*USER_UNIT, y*USER_UNIT);
		if (!title.isEmpty()) {
			contentStream.setFont(fontBold, 7.0f * POINT_TO_MM * USER_UNIT);
			contentStream.showText(title);
			contentStream.showText(" ");
		}
		contentStream.setFont(font, 7.0f * POINT_TO_MM * USER_UNIT);
		contentStream.showText(content);
		contentStream.endText();
			
	}

	/**
	 * Returns a ',' delimiter if the expression is true
	 * 
	 * @param b
	 * @return
	 */
	private String delim(boolean b) {
		return b ? "," : "";
	}
	
	public PDPageContentStream getPDPageContentStream() {
		return this.contentStream;
	}

	public boolean isAutoClose() {
		return autoClose;
	}

	public void setAutoClose(boolean autoClose) {
		this.autoClose = autoClose;
	}

	public boolean isPrintReceipt() {
		return printReceipt;
	}

	public void setPrintReceipt(boolean printReceipt) {
		this.printReceipt = printReceipt;
	}

	public int getCutoffLimit() {
		return cutoffLimit;
	}

	public void setCutoffLimit(int cutoffLimit) {
		this.cutoffLimit = cutoffLimit;
	}

}
